#!/usr/bin/env python3
import sqlite3
import os
import matplotlib.pyplot as plt
from datetime import datetime

# CONFIGURACI칍N DE RUTAS
BASE_DIR = "/home/dietpi/intel_center_odroid/automation"
DB_PATH = "/home/dietpi/intel_center_odroid/data/news.db"
POSTS_DIR = "/home/dietpi/intel_center_odroid/blog/content/post/"
IMG_DIR = "/home/dietpi/intel_center_odroid/blog/static/images/mensuales/"
LOGS_A_LIMPIAR = [
    f"{BASE_DIR}/cron_log.txt",
    f"{BASE_DIR}/analista.log",
    f"{BASE_DIR}/mensual.log"
]

def generar_reporte_mensual():
    if not os.path.exists(IMG_DIR): os.makedirs(IMG_DIR)
    
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    
    # 1. OBTENER DATOS DE VOLUMEN DIARIO
    query_vol = """
    SELECT date(timestamp), COUNT(*) 
    FROM news 
    WHERE timestamp > datetime('now', '-30 days')
    GROUP BY date(timestamp) ORDER BY date(timestamp);
    """
    cur.execute(query_vol)
    datos_vol = cur.fetchall()
    
    if not datos_vol:
        print("[-] Sin datos para el informe mensual.")
        conn.close()
        return

    # Generar Gr치fico
    fechas = [d[0][-2:] for d in datos_vol] # Solo el d칤a para no amontonar texto
    valores = [d[1] for d in datos_vol]
    
    plt.figure(figsize=(10, 5))
    plt.plot(fechas, valores, color='cyan', marker='o', linestyle='-', linewidth=2)
    plt.fill_between(fechas, valores, color='cyan', alpha=0.1)
    plt.title(f"Volumen de Inteligencia - {datetime.now().strftime('%B %Y')}")
    plt.xlabel("D칤a del mes")
    plt.ylabel("Se침ales detectadas")
    plt.grid(True, alpha=0.2)
    
    img_name = f"volumen-{datetime.now().strftime('%y%m')}.png"
    plt.savefig(os.path.join(IMG_DIR, img_name), bbox_inches='tight')
    plt.close()

    # 2. REDACTAR INFORME MD
    nombre_archivo = datetime.now().strftime("%y%m") + "-INFORME-MENSUAL.md"
    REPORT_PATH = os.path.join(POSTS_DIR, nombre_archivo)
    
    with open(REPORT_PATH, "w") as f:
        f.write(f"---\ntitle: \"Informe Mensual de Inteligencia: {datetime.now().strftime('%B %Y')}\"\ndate: {datetime.now().isoformat()}\n---\n\n")
        f.write(f"## 游늵 An치lisis de Volumen Mensual\n\n")
        f.write(f"![Volumen Diario](../../images/mensuales/{img_name})\n\n")
        f.write(f"### 游 Conclusi칩n Operativa\n\n")
        
        total_mes = sum(valores)
        promedio = total_mes / len(valores)
        
        f.write(f"> El nodo Odroid-C2 ha procesado **{total_mes} se침ales** este mes, con un promedio de **{promedio:.1f} eventos/d칤a**. ")
        f.write("El sistema de almacenamiento de 50GB se encuentra en estado 칩ptimo tras la rotaci칩n de logs.\n")

    conn.close()
    print(f"[+] Informe Mensual Generado: {REPORT_PATH}")

    # 3. HIGIENE OPERATIVA (Limpieza de logs para no saturar los 50GB)
    print("[*] Iniciando rotaci칩n de logs...")
    for log_file in LOGS_A_LIMPIAR:
        if os.path.exists(log_file):
            with open(log_file, "w") as f:
                f.write(f"--- Log reseteado tras Informe Mensual: {datetime.now()} ---\n")
            print(f"[+] Log saneado: {os.path.basename(log_file)}")

if __name__ == "__main__":
    generar_reporte_mensual()
